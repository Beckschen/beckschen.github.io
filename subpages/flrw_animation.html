<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FLRW Universe — Robertson-Walker Dynamics</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Crimson+Pro:ital,wght@0,300;0,400;1,300&display=swap');

  :root {
    --bg: #04050a;
    --panel: rgba(10,14,28,0.85);
    --border: rgba(80,140,255,0.18);
    --accent: #4fa8ff;
    --accent2: #ff6b6b;
    --accent3: #7affd4;
    --text: #c8d8f0;
    --dim: rgba(200,216,240,0.45);
    --glow: 0 0 18px rgba(79,168,255,0.35);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
  }

  /* Starfield background */
  #stars { position: fixed; inset: 0; z-index: 0; }

  #main {
    position: relative; z-index: 1;
    display: grid;
    grid-template-columns: 1fr 340px;
    grid-template-rows: auto 1fr auto;
    height: 100vh;
    gap: 0;
  }

  /* Header */
  header {
    grid-column: 1 / -1;
    padding: 16px 28px 10px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: baseline; gap: 20px;
    background: rgba(4,5,10,0.7);
    backdrop-filter: blur(8px);
  }
  header h1 {
    font-family: 'Crimson Pro', serif;
    font-size: 1.55rem;
    font-weight: 300;
    letter-spacing: 0.04em;
    color: #e0ecff;
  }
  header h1 em { color: var(--accent); font-style: italic; }
  header .subtitle {
    font-size: 0.62rem;
    color: var(--dim);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  /* Universe canvas */
  #universe-wrap {
    position: relative;
    overflow: hidden;
    background: radial-gradient(ellipse 70% 70% at 50% 50%, #08101e 0%, #04050a 100%);
  }
  #universe { width: 100%; height: 100%; display: block; }

  /* Hubble sphere overlay */
  #hubble-label {
    position: absolute;
    top: 14px; left: 50%;
    transform: translateX(-50%);
    font-size: 0.6rem;
    color: rgba(79,168,255,0.5);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    pointer-events: none;
  }

  /* Side panel */
  #panel {
    border-left: 1px solid var(--border);
    background: var(--panel);
    backdrop-filter: blur(12px);
    display: flex; flex-direction: column; gap: 0;
    overflow-y: auto;
  }

  .section {
    padding: 18px 20px 16px;
    border-bottom: 1px solid var(--border);
  }
  .section-title {
    font-size: 0.58rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 12px;
    opacity: 0.9;
  }

  /* Scale factor plot */
  #plot-canvas { width: 100%; border-radius: 4px; display: block; }

  /* Controls */
  .param-row {
    display: flex; align-items: center;
    gap: 10px; margin-bottom: 10px;
  }
  .param-label {
    font-family: 'Crimson Pro', serif;
    font-size: 0.9rem;
    color: var(--dim);
    width: 72px; flex-shrink: 0;
  }
  .param-label span { color: var(--accent); }
  input[type=range] {
    flex: 1;
    -webkit-appearance: none;
    height: 3px;
    background: rgba(79,168,255,0.2);
    border-radius: 2px;
    outline: none;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 13px; height: 13px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    box-shadow: 0 0 8px var(--accent);
  }
  .param-value {
    font-size: 0.68rem;
    color: var(--accent3);
    width: 34px;
    text-align: right;
  }

  /* Model buttons */
  .model-buttons {
    display: flex; gap: 8px; flex-wrap: wrap;
  }
  .model-btn {
    flex: 1;
    padding: 7px 6px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--dim);
    font-family: 'Space Mono', monospace;
    font-size: 0.58rem;
    letter-spacing: 0.06em;
    cursor: pointer;
    border-radius: 3px;
    text-transform: uppercase;
    transition: all 0.2s;
  }
  .model-btn:hover { border-color: var(--accent); color: var(--accent); }
  .model-btn.active {
    background: rgba(79,168,255,0.15);
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: var(--glow);
  }

  /* Playback */
  .play-row {
    display: flex; align-items: center; gap: 12px;
  }
  #play-btn {
    width: 36px; height: 36px;
    border: 1px solid var(--accent);
    border-radius: 50%;
    background: rgba(79,168,255,0.1);
    color: var(--accent);
    font-size: 0.9rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
  }
  #play-btn:hover { background: rgba(79,168,255,0.25); }
  #reset-btn {
    padding: 7px 14px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--dim);
    font-family: 'Space Mono', monospace;
    font-size: 0.6rem;
    cursor: pointer; border-radius: 3px;
    transition: all 0.2s;
  }
  #reset-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  /* Live readout */
  .readout {
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 10px 14px;
  }
  .readout-row {
    display: flex; justify-content: space-between;
    font-size: 0.65rem; margin-bottom: 4px;
    color: var(--dim);
  }
  .readout-row:last-child { margin-bottom: 0; }
  .readout-row .val { color: var(--accent3); }

  /* Equation */
  .eq-box {
    background: rgba(0,0,0,0.35);
    border-left: 2px solid var(--accent);
    padding: 10px 12px;
    border-radius: 0 4px 4px 0;
  }
  .eq-box p {
    font-family: 'Crimson Pro', serif;
    font-size: 0.85rem;
    color: rgba(200,220,255,0.75);
    line-height: 1.7;
  }
  .eq-box .eq { color: var(--accent3); font-style: italic; }

  /* Legend */
  .legend { display: flex; gap: 14px; flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.6rem; color: var(--dim); }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

  /* Footer */
  footer {
    grid-column: 1 / -1;
    padding: 8px 28px;
    border-top: 1px solid var(--border);
    font-size: 0.55rem;
    color: rgba(200,216,240,0.3);
    letter-spacing: 0.07em;
    background: rgba(4,5,10,0.8);
  }

  /* Epoch indicator */
  #epoch-badge {
    position: absolute;
    bottom: 16px; left: 50%;
    transform: translateX(-50%);
    padding: 5px 16px;
    border: 1px solid var(--border);
    background: rgba(4,5,10,0.75);
    border-radius: 20px;
    font-size: 0.6rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--accent);
    pointer-events: none;
    backdrop-filter: blur(6px);
  }
</style>
</head>
<body>

<canvas id="stars"></canvas>

<div id="main">
  <header>
    <h1>Friedmann–Lemaître–<em>Robertson–Walker</em> Universe</h1>
    <span class="subtitle">GR Cosmological Dynamics · Homogeneous &amp; Isotropic</span>
  </header>

  <div id="universe-wrap">
    <canvas id="universe"></canvas>
    <div id="hubble-label">Comoving Frame — Hubble Flow</div>
    <div id="epoch-badge" id="epoch-badge">Loading…</div>
  </div>

  <div id="panel">
    <!-- Scale factor plot -->
    <div class="section">
      <div class="section-title">Scale Factor a(t)</div>
      <canvas id="plot-canvas" height="130"></canvas>
      <div class="legend" style="margin-top:8px">
        <div class="legend-item"><div class="legend-dot" style="background:#4fa8ff"></div>Current model</div>
        <div class="legend-item"><div class="legend-dot" style="background:#ff6b6b;opacity:0.6"></div>Radiation-dom.</div>
        <div class="legend-item"><div class="legend-dot" style="background:#7affd4;opacity:0.6"></div>ΛCDM (Λ-dom.)</div>
      </div>
    </div>

    <!-- Presets -->
    <div class="section">
      <div class="section-title">Cosmological Preset</div>
      <div class="model-buttons">
        <button class="model-btn" data-model="radiation">Radiation</button>
        <button class="model-btn active" data-model="matter">Matter</button>
        <button class="model-btn" data-model="lambda">Dark Energy</button>
        <button class="model-btn" data-model="lcdm">ΛCDM</button>
      </div>
    </div>

    <!-- Parameters -->
    <div class="section">
      <div class="section-title">Density Parameters</div>
      <div class="param-row">
        <div class="param-label">Ω<span>_m</span></div>
        <input type="range" id="omega-m" min="0" max="1" step="0.01" value="0.3">
        <div class="param-value" id="omega-m-val">0.30</div>
      </div>
      <div class="param-row">
        <div class="param-label">Ω<span>_Λ</span></div>
        <input type="range" id="omega-l" min="0" max="1.2" step="0.01" value="0.7">
        <div class="param-value" id="omega-l-val">0.70</div>
      </div>
      <div class="param-row">
        <div class="param-label">Ω<span>_r</span></div>
        <input type="range" id="omega-r" min="0" max="0.3" step="0.005" value="0.0">
        <div class="param-value" id="omega-r-val">0.00</div>
      </div>
      <div class="param-row">
        <div class="param-label">Speed</div>
        <input type="range" id="speed" min="0.1" max="5" step="0.1" value="1.0">
        <div class="param-value" id="speed-val">1.0×</div>
      </div>
    </div>

    <!-- Live readout -->
    <div class="section">
      <div class="section-title">Live Observables</div>
      <div class="readout">
        <div class="readout-row"><span>Scale factor a(t)</span><span class="val" id="r-a">1.000</span></div>
        <div class="readout-row"><span>Hubble param H(t)</span><span class="val" id="r-H">0.000</span></div>
        <div class="readout-row"><span>Deceleration q</span><span class="val" id="r-q">0.000</span></div>
        <div class="readout-row"><span>Cosmic time t</span><span class="val" id="r-t">0.00</span></div>
      </div>
    </div>

    <!-- Playback -->
    <div class="section">
      <div class="section-title">Playback</div>
      <div class="play-row">
        <button id="play-btn">▶</button>
        <button id="reset-btn">Reset t=0</button>
      </div>
    </div>

    <!-- Equation -->
    <div class="section">
      <div class="section-title">Friedmann Equation</div>
      <div class="eq-box">
        <p><span class="eq">H²</span> = (ȧ/a)² = <span class="eq">8πG/3</span>·ρ − <span class="eq">k/a²</span> + <span class="eq">Λ/3</span></p>
        <p style="margin-top:6px; font-size:0.75rem; color:var(--dim)">FLRW metric: ds² = −c²dt² + a(t)²[dr²/(1−kr²) + r²dΩ²]</p>
      </div>
    </div>
  </div>

  <footer>Friedmann–Lemaître–Robertson–Walker metric · Ignores quantum gravity · Assumes homogeneity &amp; isotropy (spherical symmetry) · ©&nbsp;GR Cosmology Visualizer</footer>
</div>

<div id="epoch-badge">Matter Dominated</div>

<script>
// ─── Starfield ───────────────────────────────────────────────────────────────
const starsC = document.getElementById('stars');
const sc = starsC.getContext('2d');
let stars = [];
function initStars() {
  starsC.width = window.innerWidth;
  starsC.height = window.innerHeight;
  stars = Array.from({length: 280}, () => ({
    x: Math.random() * starsC.width,
    y: Math.random() * starsC.height,
    r: Math.random() * 1.1 + 0.2,
    b: Math.random() * 0.6 + 0.1,
    bv: (Math.random() - 0.5) * 0.008
  }));
}
function drawStars() {
  sc.clearRect(0,0,starsC.width,starsC.height);
  for (const s of stars) {
    s.b = Math.max(0.05, Math.min(0.75, s.b + s.bv));
    if (s.b <= 0.05 || s.b >= 0.75) s.bv *= -1;
    sc.beginPath();
    sc.arc(s.x, s.y, s.r, 0, Math.PI*2);
    sc.fillStyle = `rgba(200,220,255,${s.b})`;
    sc.fill();
  }
}
initStars();

// ─── Universe canvas ─────────────────────────────────────────────────────────
const uCanvas = document.getElementById('universe');
const uc = uCanvas.getContext('2d');

let galaxies = [];
const N_GALAXIES = 60;

function initGalaxies() {
  galaxies = [];
  for (let i = 0; i < N_GALAXIES; i++) {
    const angle = Math.random() * Math.PI * 2;
    const r = Math.random();
    const coR = r * Math.cos(angle);
    const coTheta = r * Math.sin(angle);
    const hue = Math.floor(Math.random() * 60 + 190); // blue/teal tones
    const size = Math.random() * 2.2 + 0.8;
    const glowSize = size * (Math.random() * 3 + 2);
    galaxies.push({ cx: coR, cy: coTheta, hue, size, glowSize, twinkle: Math.random()*Math.PI*2 });
  }
}

// ─── Cosmology ────────────────────────────────────────────────────────────────
let t = 0.01; // cosmic time (normalized)
let playing = true;
let params = { Om: 0.3, Ol: 0.7, Or: 0.0, k: 0 };
let speed = 1.0;

// Integrate a(t) numerically via Friedmann equation
// H²(a) = H0² * [Om/a³ + Or/a⁴ + Ol + (1-Om-Ol-Or)/a²]   (k≈0)
function Hsq(a) {
  const {Om, Ol, Or} = params;
  const Ok = 0; // flat
  return Om/(a*a*a) + Or/(a*a*a*a) + Ol + Ok/(a*a);
}

function Hval(a) { return Math.sqrt(Math.max(0, Hsq(a))); }

// Solve a(t) by integrating da/dt = a*H(a)
// Build a lookup table once, update when params change
let aTable = [];
const T_MAX = 3.0;
const N_STEPS = 2000;

function buildTable() {
  aTable = [];
  let a = 0.005;
  let tau = 0;
  const dt = T_MAX / N_STEPS;
  aTable.push({t: tau, a});
  for (let i = 0; i < N_STEPS; i++) {
    const H = Hval(a);
    if (!isFinite(H) || H < 0) break;
    const da = a * H * dt;
    a = Math.max(1e-6, a + da);
    tau += dt;
    aTable.push({t: tau, a});
    if (a > 15) break;
  }
}

function getA(time) {
  if (aTable.length < 2) return 1;
  const last = aTable[aTable.length-1];
  if (time >= last.t) return last.a;
  // binary search
  let lo = 0, hi = aTable.length-1;
  while (hi - lo > 1) {
    const mid = (lo+hi)>>1;
    if (aTable[mid].t <= time) lo = mid; else hi = mid;
  }
  const frac = (time - aTable[lo].t)/(aTable[hi].t - aTable[lo].t);
  return aTable[lo].a + frac*(aTable[hi].a - aTable[lo].a);
}

function getAdot(time) {
  const eps = 0.002;
  return (getA(time+eps) - getA(time-eps))/(2*eps);
}

buildTable();

// ─── Plot ─────────────────────────────────────────────────────────────────────
const plotC = document.getElementById('plot-canvas');
const pc = plotC.getContext('2d');

function drawPlot(aT) {
  const W = plotC.offsetWidth * devicePixelRatio;
  const H = 130 * devicePixelRatio;
  plotC.width = W; plotC.height = H;
  pc.scale(devicePixelRatio, devicePixelRatio);
  const w = plotC.offsetWidth, h = 130;

  pc.clearRect(0,0,w,h);
  pc.fillStyle='rgba(0,0,0,0.2)';
  pc.fillRect(0,0,w,h);

  // Axes
  pc.strokeStyle='rgba(80,120,200,0.2)';
  pc.lineWidth=1;
  pc.beginPath(); pc.moveTo(36,8); pc.lineTo(36,h-20); pc.lineTo(w-8,h-20); pc.stroke();

  const aMax = Math.max(5, aT * 1.4);
  const tEnd = aTable.length > 0 ? aTable[aTable.length-1].t : T_MAX;

  function tx(time) { return 36 + (time/tEnd)*(w-44); }
  function ty(a) { return (h-20) - (a/aMax)*(h-32); }

  // Reference curves
  // Radiation: a ~ t^(1/2)
  const drawRef = (color, fn) => {
    pc.beginPath(); pc.strokeStyle=color; pc.lineWidth=1; pc.setLineDash([4,4]);
    let first=true;
    for (let i=0;i<aTable.length;i++) {
      const row = aTable[i];
      const y = ty(fn(row.t)); const x = tx(row.t);
      if (first) { pc.moveTo(x,y); first=false; } else pc.lineTo(x,y);
    }
    pc.stroke(); pc.setLineDash([]);
  };

  // radiation ref (hardcoded approx a~t^0.5)
  pc.beginPath(); pc.strokeStyle='rgba(255,107,107,0.4)'; pc.lineWidth=1; pc.setLineDash([3,5]);
  let fr=true;
  for (let step=0;step<aTable.length;step++) {
    const row=aTable[step];
    const aRad = 0.3*Math.sqrt(row.t+0.0001);
    const x=tx(row.t), y=ty(aRad);
    if(fr){pc.moveTo(x,y);fr=false;}else pc.lineTo(x,y);
  }
  pc.stroke(); pc.setLineDash([]);

  // Lambda-CDM ref (approx exponential late)
  pc.beginPath(); pc.strokeStyle='rgba(122,255,212,0.3)'; pc.lineWidth=1; pc.setLineDash([3,5]);
  let fl=true;
  for (let step=0;step<aTable.length;step++) {
    const row=aTable[step];
    const aLam = 0.15*Math.cosh(0.8*row.t);
    const x=tx(row.t), y=ty(aLam);
    if(fl){pc.moveTo(x,y);fl=false;}else pc.lineTo(x,y);
  }
  pc.stroke(); pc.setLineDash([]);

  // Main curve
  pc.beginPath(); pc.strokeStyle='#4fa8ff'; pc.lineWidth=2;
  let first=true;
  for (let i=0; i<aTable.length; i++) {
    const row=aTable[i];
    const x=tx(row.t), y=ty(row.a);
    if(first){pc.moveTo(x,y);first=false;}else pc.lineTo(x,y);
  }
  pc.stroke();

  // Current time marker
  const cx=tx(t), ca=getA(t), cy=ty(ca);
  pc.beginPath(); pc.strokeStyle='rgba(79,168,255,0.3)'; pc.lineWidth=1; pc.setLineDash([2,4]);
  pc.moveTo(cx,h-20); pc.lineTo(cx,8); pc.stroke(); pc.setLineDash([]);
  pc.beginPath(); pc.arc(cx,cy,5,0,Math.PI*2);
  pc.fillStyle='#4fa8ff'; pc.fill();
  pc.beginPath(); pc.arc(cx,cy,9,0,Math.PI*2);
  pc.strokeStyle='rgba(79,168,255,0.4)'; pc.lineWidth=1.5; pc.stroke();

  // Labels
  pc.fillStyle='rgba(200,220,255,0.4)'; pc.font='8px Space Mono';
  pc.fillText('a(t)',2,14);
  pc.fillText('t',w-14,h-6);
  pc.fillText('1',38,ty(1)+3);
}

// ─── Universe draw ────────────────────────────────────────────────────────────
function resizeUniverse() {
  uCanvas.width = uCanvas.offsetWidth;
  uCanvas.height = uCanvas.offsetHeight;
}

function drawUniverse(a) {
  const W = uCanvas.width, H = uCanvas.height;
  uc.clearRect(0,0,W,H);

  const cx = W/2, cy = H/2;
  const baseRadius = Math.min(W,H)*0.38;

  // Hubble sphere
  const sphereR = baseRadius * Math.min(a, 3.5) / 1.0;
  const grad = uc.createRadialGradient(cx,cy,0,cx,cy,sphereR);
  grad.addColorStop(0, 'rgba(10,30,80,0.18)');
  grad.addColorStop(0.7, 'rgba(5,15,40,0.10)');
  grad.addColorStop(1, 'rgba(79,168,255,0.04)');
  uc.beginPath(); uc.arc(cx,cy,sphereR,0,Math.PI*2);
  uc.fillStyle=grad; uc.fill();

  // Hubble sphere border
  uc.beginPath(); uc.arc(cx,cy,sphereR,0,Math.PI*2);
  uc.strokeStyle=`rgba(79,168,255,${0.08+0.04*Math.sin(Date.now()*0.001)})`;
  uc.lineWidth=1; uc.stroke();

  // Grid circles (comoving shells)
  for (let ri=1; ri<=4; ri++) {
    const sr = (ri/4)*baseRadius;
    const physR = sr * a;
    uc.beginPath(); uc.arc(cx,cy,physR,0,Math.PI*2);
    uc.strokeStyle='rgba(79,168,255,0.04)'; uc.lineWidth=1; uc.stroke();
  }

  // Galaxies
  const now = Date.now()*0.001;
  for (const g of galaxies) {
    const px = cx + g.cx * baseRadius * a;
    const py = cy + g.cy * baseRadius * a;
    const tw = 0.7 + 0.3*Math.sin(now*0.8 + g.twinkle);

    // Glow
    const gr = uc.createRadialGradient(px,py,0,px,py,g.glowSize*a*0.5+6);
    gr.addColorStop(0, `hsla(${g.hue},80%,75%,${0.55*tw})`);
    gr.addColorStop(1, `hsla(${g.hue},80%,60%,0)`);
    uc.beginPath(); uc.arc(px,py,g.glowSize*a*0.4+6,0,Math.PI*2);
    uc.fillStyle=gr; uc.fill();

    // Core
    uc.beginPath(); uc.arc(px,py,g.size,0,Math.PI*2);
    uc.fillStyle=`hsla(${g.hue},90%,88%,${0.85*tw})`;
    uc.fill();
  }

  // Observer at center
  uc.beginPath(); uc.arc(cx,cy,5,0,Math.PI*2);
  uc.fillStyle='rgba(255,255,200,0.9)'; uc.fill();
  uc.beginPath(); uc.arc(cx,cy,11,0,Math.PI*2);
  uc.strokeStyle='rgba(255,255,180,0.25)'; uc.lineWidth=2; uc.stroke();
  uc.beginPath(); uc.arc(cx,cy,18,0,Math.PI*2);
  uc.strokeStyle='rgba(255,255,180,0.08)'; uc.lineWidth=1; uc.stroke();
}

// ─── Epoch label ─────────────────────────────────────────────────────────────
const epochBadge = document.getElementById('epoch-badge');
function updateEpoch(a) {
  const {Om, Ol, Or} = params;
  const rhoR = Or/(a*a*a*a);
  const rhoM = Om/(a*a*a);
  const rhoL = Ol;
  const max = Math.max(rhoR, rhoM, rhoL);
  if (max === rhoR) epochBadge.textContent = 'Radiation Dominated';
  else if (max === rhoM) epochBadge.textContent = 'Matter Dominated';
  else epochBadge.textContent = 'Dark Energy Dominated';
}

// ─── Readout update ───────────────────────────────────────────────────────────
function updateReadout(a, adot, time) {
  const H = adot / a;
  const {Om, Ol, Or} = params;
  const rhoR = Or/(a*a*a*a);
  const rhoM = Om/(a*a*a);
  const rhoL = Ol;
  const rhoCrit = Hsq(a);
  const q = -(a * (getA(time+0.01) - 2*a + getA(time-0.01)) / (0.01*0.01)) / (adot*adot);

  document.getElementById('r-a').textContent = a.toFixed(4);
  document.getElementById('r-H').textContent = isFinite(H) ? H.toFixed(4) : '∞';
  document.getElementById('r-q').textContent = isFinite(q) ? q.toFixed(4) : '—';
  document.getElementById('r-t').textContent = time.toFixed(3) + ' t/t₀';
}

// ─── Animation loop ───────────────────────────────────────────────────────────
let lastTime = null;
function loop(ts) {
  if (!lastTime) lastTime = ts;
  const dt = Math.min((ts - lastTime)/1000, 0.05) * speed;
  lastTime = ts;

  if (playing) {
    t += dt * 0.12;
    const maxT = aTable.length > 0 ? aTable[aTable.length-1].t : T_MAX;
    if (t > maxT * 0.95) t = 0.01;
  }

  const a = getA(t);
  const adot = getAdot(t);

  drawStars();
  drawUniverse(a);
  drawPlot(a);
  updateReadout(a, adot, t);
  updateEpoch(a);

  requestAnimationFrame(loop);
}

// ─── UI interactions ──────────────────────────────────────────────────────────
function syncParams() {
  params.Om = +document.getElementById('omega-m').value;
  params.Ol = +document.getElementById('omega-l').value;
  params.Or = +document.getElementById('omega-r').value;
  document.getElementById('omega-m-val').textContent = params.Om.toFixed(2);
  document.getElementById('omega-l-val').textContent = params.Ol.toFixed(2);
  document.getElementById('omega-r-val').textContent = params.Or.toFixed(2);
  buildTable();
}

['omega-m','omega-l','omega-r'].forEach(id => {
  document.getElementById(id).addEventListener('input', syncParams);
});

document.getElementById('speed').addEventListener('input', e => {
  speed = +e.target.value;
  document.getElementById('speed-val').textContent = speed.toFixed(1) + '×';
});

const playBtn = document.getElementById('play-btn');
playBtn.addEventListener('click', () => {
  playing = !playing;
  playBtn.textContent = playing ? '⏸' : '▶';
});

document.getElementById('reset-btn').addEventListener('click', () => {
  t = 0.01;
});

const presets = {
  radiation: { Om: 0.0, Ol: 0.0, Or: 1.0 },
  matter:    { Om: 1.0, Ol: 0.0, Or: 0.0 },
  lambda:    { Om: 0.0, Ol: 1.0, Or: 0.0 },
  lcdm:      { Om: 0.3, Ol: 0.7, Or: 0.0 },
};

document.querySelectorAll('.model-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const p = presets[btn.dataset.model];
    params.Om = p.Om; params.Ol = p.Ol; params.Or = p.Or;
    document.getElementById('omega-m').value = p.Om;
    document.getElementById('omega-l').value = p.Ol;
    document.getElementById('omega-r').value = p.Or;
    document.getElementById('omega-m-val').textContent = p.Om.toFixed(2);
    document.getElementById('omega-l-val').textContent = p.Ol.toFixed(2);
    document.getElementById('omega-r-val').textContent = p.Or.toFixed(2);
    buildTable();
    t = 0.01;
  });
});

// ─── Resize ───────────────────────────────────────────────────────────────────
window.addEventListener('resize', () => {
  initStars();
  resizeUniverse();
  initGalaxies();
});

// ─── Init ─────────────────────────────────────────────────────────────────────
resizeUniverse();
initGalaxies();
requestAnimationFrame(loop);
</script>
</body>
</html>
